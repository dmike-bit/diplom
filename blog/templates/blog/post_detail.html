{% extends "blog/base.html" %}

{% block title %}{{ post.title }} - Matrix Blog{% endblock %}

{% block extra_js %}
<script>
function likePost(postId) {
    fetch(`/post/${postId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const likeBtn = document.getElementById('likeBtn');
        const likeCount = document.getElementById('likeCount');
        
        if (data.liked) {
            likeBtn.innerHTML = '<i class="bi bi-heart-fill"></i> Liked';
            likeBtn.classList.remove('btn-outline-matrix');
            likeBtn.classList.add('btn-matrix');
        } else {
            likeBtn.innerHTML = '<i class="bi bi-heart"></i> Like';
            likeBtn.classList.remove('btn-matrix');
            likeBtn.classList.add('btn-outline-matrix');
        }
        
        likeCount.textContent = data.like_count;
    })
    .catch(error => console.error('Error:', error));
}

function likeComment(commentId) {
    fetch(`/comment/${commentId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        const likeBtn = document.getElementById(`commentLikeBtn${commentId}`);
        const likeCount = document.getElementById(`commentLikeCount${commentId}`);
        
        if (data.liked) {
            likeBtn.innerHTML = '<i class="bi bi-heart-fill"></i>';
            likeBtn.classList.remove('btn-outline-matrix', 'btn-sm');
            likeBtn.classList.add('btn-matrix', 'btn-sm');
        } else {
            likeBtn.innerHTML = '<i class="bi bi-heart"></i>';
            likeBtn.classList.remove('btn-matrix', 'btn-sm');
            likeBtn.classList.add('btn-outline-matrix', 'btn-sm');
        }
        
        likeCount.textContent = data.like_count;
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}

{% block content %}
<article class="matrix-card p-4 mb-4">
    <!-- Post Header -->
    <header class="mb-4">
        {% if post.image %}
        <img src="{{ post.image.url }}" class="img-fluid rounded mb-3" alt="{{ post.title }}" style="max-height: 400px; width: 100%; object-fit: cover;">
        {% endif %}
        
        <h1 class="text-matrix">{{ post.title }}</h1>
        
        <div class="d-flex flex-wrap align-items-center text-muted mb-3">
            <div class="me-3">
                <i class="bi bi-person"></i> 
                <a href="{% url 'user_profile' username=post.author.username %}" class="text-matrix text-decoration-none">
                    {{ post.author.username }}
                </a>
            </div>
            <div class="me-3">
                <i class="bi bi-calendar"></i> {{ post.created_date|date:"F d, Y" }}
            </div>
            {% if post.category %}
            <div class="me-3">
                <i class="bi bi-tag"></i> 
                <span class="badge bg-matrix">{{ post.category.name }}</span>
            </div>
            {% endif %}
            <div class="me-3">
                <i class="bi bi-eye"></i> {{ post.views }} views
            </div>
        </div>
    </header>

    <!-- Post Content -->
    <div class="post-content mb-4">
        {{ post.content|linebreaks }}
    </div>

    <!-- Post Tags -->
    {% if post.tags %}
    <div class="mb-4">
        <strong class="text-matrix">Tags:</strong>
        {% for tag in post.tags.split %}
        <span class="badge bg-secondary me-1">{{ tag }}</span>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Post Actions -->
    <div class="d-flex justify-content-between align-items-center border-top border-matrix pt-3">
        <div>
            <button class="btn {% if user_liked %}btn-matrix{% else %}btn-outline-matrix{% endif %} btn-sm me-2" 
                    onclick="likePost({{ post.pk }})" id="likeBtn">
                <i class="bi bi-heart{% if user_liked %}-fill{% endif %}"></i> 
                <span id="likeCount">{{ post.like_count }}</span>
            </button>
            
            {% if user.is_authenticated and user == post.author or user.is_staff %}
            <a href="{% url 'post_edit' pk=post.pk %}" class="btn btn-outline-matrix btn-sm">
                <i class="bi bi-pencil"></i> Edit
            </a>
            {% endif %}
        </div>
        
        <div class="text-muted">
            <i class="bi bi-chat"></i> {{ comments.count }} comments
        </div>
    </div>
</article>

<!-- Comments Section -->
<section class="matrix-card p-4">
    <h3 class="text-matrix mb-4">
        <i class="bi bi-chat"></i> Comments ({{ comments.count }})
    </h3>

    <!-- Comment Form -->
    {% if user.is_authenticated and not user.profile.is_banned %}
    <div class="mb-4 p-3" style="background: rgba(0, 255, 65, 0.05); border-radius: 8px;">
        <h5 class="text-matrix">Add Comment</h5>
        <form method="post" action="{% url 'comment_create' post_pk=post.pk %}">
            {% csrf_token %}
            {{ comment_form.text }}
            <button type="submit" class="btn btn-matrix mt-2">
                <i class="bi bi-send"></i> Post Comment
            </button>
        </form>
    </div>
    {% elif user.is_authenticated and user.profile.is_banned %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> You are banned from posting comments.
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Please <a href="{% url 'login' %}" class="text-matrix">login</a> to post comments.
    </div>
    {% endif %}

    <!-- Comments List -->
    <div class="comments-list">
        {% for comment in comments %}
        <div class="border-bottom border-secondary pb-3 mb-3">
            <!-- Main Comment -->
            <div class="d-flex align-items-start mb-2">
                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="text-matrix">{{ comment.author.username }}</strong>
                            <small class="text-muted ms-2">{{ comment.created_date|timesince }} ago</small>
                        </div>
                        <div>
                            <button class="btn {% if user.is_authenticated and user in comment.likes.all %}btn-matrix{% else %}btn-outline-matrix{% endif %} btn-sm me-1" 
                                    onclick="likeComment({{ comment.pk }})" id="commentLikeBtn{{ comment.pk }}">
                                <i class="bi bi-heart{% if user.is_authenticated and user in comment.likes.all %}-fill{% endif %}"></i>
                                <span id="commentLikeCount{{ comment.pk }}">{{ comment.like_count }}</span>
                            </button>
                        </div>
                    </div>
                    <p class="mb-2 mt-2">{{ comment.text|linebreaks }}</p>
                    
                    <!-- Reply Form -->
                    {% if user.is_authenticated and not user.profile.is_banned %}
                    <button class="btn btn-outline-matrix btn-sm mb-2" type="button" data-bs-toggle="collapse" 
                            data-bs-target="#replyForm{{ comment.pk }}">
                        <i class="bi bi-reply"></i> Reply
                    </button>
                    
                    <div class="collapse mt-2" id="replyForm{{ comment.pk }}">
                        <form method="post" action="{% url 'reply_create' comment_pk=comment.pk %}">
                            {% csrf_token %}
                            {{ reply_form.text }}
                            <button type="submit" class="btn btn-matrix btn-sm mt-1">
                                <i class="bi bi-send"></i> Post Reply
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Replies -->
            {% for reply in comment.replies.all %}
            {% if reply.is_active %}
            <div class="ms-4 ps-3 border-start border-matrix mt-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong class="text-matrix">{{ reply.author.username }}</strong>
                        <small class="text-muted ms-2">{{ reply.created_date|timesince }} ago</small>
                    </div>
                    <button class="btn {% if user.is_authenticated and user in reply.likes.all %}btn-matrix{% else %}btn-outline-matrix{% endif %} btn-sm" 
                            onclick="likeComment({{ reply.pk }})" id="commentLikeBtn{{ reply.pk }}">
                        <i class="bi bi-heart{% if user.is_authenticated and user in reply.likes.all %}-fill{% endif %}"></i>
                        <span id="commentLikeCount{{ reply.pk }}">{{ reply.like_count }}</span>
                    </button>
                </div>
                <p class="mb-0 mt-1">{{ reply.text|linebreaks }}</p>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% empty %}
        <div class="text-center text-muted py-4">
            <i class="bi bi-chat display-4 d-block mb-2"></i>
            <p>No comments yet. Be the first to break the silence.</p>
        </div>
        {% endfor %}
    </div>
</section>
{% endblock %}
