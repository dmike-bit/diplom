user nginx;  # Пользователь, под которым работает nginx
worker_processes auto;  # Автоматическое определение количества рабочих процессов
error_log /var/log/nginx/error.log warn;  # Файл для записи ошибок (уровень предупреждения)
pid /var/run/nginx.pid;  # Файл с идентификатором процесса nginx

events {  {# Блок настроек обработки соединений #}
    worker_connections 1024;  {# Максимальное количество соединений на один рабочий процесс #}
    use epoll;  {# Использование эффективного метода обработки событий epoll #}
    multi_accept on;  {# Принятие нескольких соединений одновременно #}
}

http {  {# Блок основных настроек HTTP сервера #}
    include /etc/nginx/mime.types;  {# Включаем файл с типами MIME #}
    default_type application/octet-stream;  {# Тип по умолчанию для неизвестных файлов #}

    # Логирование (Формат логов доступа)
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '  {# Формат основного лога #}
                    '$status $body_bytes_sent "$http_referer" '  {# IP, статус, размер ответа, реферер #}
                    '"$http_user_agent" "$http_x_forwarded_for"';  {# User-Agent и IP прокси #}
    
    access_log /var/log/nginx/access.log main;  {# Файл для записи логов доступа в формате main #}

    # Основные настройки производительности
    sendfile on;  {# Включаем эффективную отправку файлов через ядро #}
    tcp_nopush on;  {# Оптимизируем отправку TCP пакетов #}
    tcp_nodelay on;  {# Отключаем алгоритм Нэгла для уменьшения задержек #}
    keepalive_timeout 65;  {# Время жизни keep-alive соединений в секундах #}
    types_hash_max_size 2048;  {# Максимальный размер хеша типов MIME #}
    client_max_body_size 16M;  {# Максимальный размер тела запроса от клиента (16 МБ) #}

    # Gzip сжатие (Сжатие ответов для экономии трафика)
    gzip on;  {# Включаем gzip сжатие #}
    gzip_vary on;  {# Добавляем заголовок Vary для правильного кэширования #}
    gzip_min_length 1024;  {# Минимальный размер файла для сжатия (1 КБ) #}
    gzip_proxied any;  {# Сжимаем ответы от всех проксированных серверов #}
    gzip_comp_level 6;  {# Уровень сжатия (от 1 до 9, где 9 - максимальное) #}
    gzip_types  {# Типы файлов для сжатия #}
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # Rate limiting (Ограничение частоты запросов)
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;  {# Зона для API: 10 запросов в секунду на IP #}
    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;  {# Зона для логина: 5 попыток в минуту на IP #}

    # Upstream для Django приложения (Группа серверов Django)
    upstream django {
        server myblog_web_sqlite:8000;  {# Основной сервер Django приложения #}
        keepalive 32;  {# Количество keep-alive соединений к upstream #}
    }

    # Включаем конфигурации сайтов
    include /etc/nginx/conf.d/*;  {# Включаем все файлы конфигурации из директории conf.d #}
}