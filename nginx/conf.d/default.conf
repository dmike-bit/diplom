# Конфигурация для работы на портах 80 (HTTP) и 443 (HTTPS)
server {  {# Начало блока конфигурации виртуального сервера #}
    listen 80;  {# Слушаем HTTP трафик на порту 80 #}
    listen 443 ssl;  {# Слушаем HTTPS трафик на порту 443 с SSL/TLS #}
    server_name 82.202.141.206 localhost myblog.local;  {# Имена сервера для определения запрашиваемого сайта #}
    
    # SSL сертификаты (Сертификаты для HTTPS шифрования)
    ssl_certificate /etc/nginx/ssl/myblog.crt;  {# Путь к сертификату сервера #}
    ssl_certificate_key /etc/nginx/ssl/myblog.key;  {# Путь к приватному ключу сертификата #}
    
    # SSL настройки безопасности (Современные настройки SSL/TLS)
    ssl_protocols TLSv1.2 TLSv1.3;  {# Поддерживаемые версии протокола #}
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;  {# Наборы шифров #}
    ssl_prefer_server_ciphers off;  {# Предпочтение шифров клиента #}
    ssl_session_cache shared:SSL:10m;  {# Кэш SSL сессий (размер 10 МБ) #}
    ssl_session_timeout 1d;  {# Тайм-аут SSL сессий (1 день) #}
    
    # Security headers (Заголовки безопасности для защиты от различных атак)
    add_header X-Frame-Options "SAMEORIGIN" always;  {# Защита от clickjacking атак #}
    add_header X-Content-Type-Options "nosniff" always;  {# Предотвращение MIME sniffing #}
    add_header X-XSS-Protection "1; mode=block" always;  {# Включение защиты от XSS #}
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;  {# Политика заголовка Referer #}
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;  {# HSTS - принудительный HTTPS #}
    add_header Cross-Origin-Opener-Policy "same-origin" always;  {# Политика COOP для изоляции контекста #}
    add_header Cross-Origin-Embedder-Policy "require-corp" always;  {# Политика COEP для ресурсов #}
    add_header Cross-Origin-Resource-Policy "same-origin" always;  {# Политика CORP для ресурсов #}
    
    # Root и index файлы (Корневая директория для статических файлов)
    root /usr/share/nginx/html;  {# Корневая директория веб-сайта #}
    index index.html index.htm;  {# Файлы по умолчанию при обращении к директории #}

    # Статические файлы (Обработка статических ресурсов CSS, JS, изображений)
    location /static/ {  {# Начало блока для URL начинающихся с /static/ #}
        alias /var/www/static/;  {# Сопоставление URL директории с файловой системой #}
        expires 1y;  {# Время кэширования (1 год) #}
        add_header Cache-Control "public, immutable";  {# Заголовки кэширования #}
        add_header X-Content-Type-Options "nosniff" always;  {# Дополнительные заголовки безопасности #}
    }

    # Медиа файлы (Обработка пользовательских загружаемых файлов)
    location /media/ {  {# Начало блока для URL начинающихся с /media/ #}
        alias /var/www/media/;  {# Директория для медиа файлов #}
        expires 1M;  {# Время кэширования (1 месяц) #}
        add_header Cache-Control "public";  {# Заголовки кэширования #}
    }

    # Favicon обработка (Специальная обработка иконок сайта)
    location = /favicon.ico {  {# Точное совпадение с /favicon.ico #}
        access_log off;  {# Отключаем логирование доступа #}
        log_not_found off;  {# Не логируем "не найдено" ошибки #}
        return 204;  {# Возвращаем код 204 No Content #}
    }
    
    # Common files обработка (Обработка стандартных служебных файлов)
    location = /robots.txt {  {# Обработка файла robots.txt для поисковых роботов #}
        access_log off;  {# Отключаем логирование #}
        log_not_found off;  {# Не логируем отсутствие файла #}
    }
    
    location = /favicon.png {  {# Альтернативная иконка в формате PNG #}
        access_log off;  {# Отключаем логирование #}
        log_not_found off;  {# Не логируем отсутствие файла #}
        return 204;  {# Возвращаем пустой ответ #}
    }

    # Django приложение (Проксирование всех остальных запросов к Django)
    location / {  {# Блок для всех остальных URL #}
        proxy_pass http://django;  {# Проксируем запросы на upstream сервер Django #}
        proxy_set_header Host $host;  {# Передаем заголовок Host #}
        proxy_set_header X-Real-IP $remote_addr;  {# Передаем реальный IP клиента #}
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  {# Список IP для прокси #}
        proxy_set_header X-Forwarded-Proto $scheme;  {# Передаем протокол (HTTP/HTTPS) #}
        proxy_set_header X-Forwarded-Host $server_name;  {# Передаем имя сервера #}
        
        # WebSocket поддержка (Настройки для WebSocket соединений)
        proxy_http_version 1.1;  {# Используем HTTP/1.1 для поддержки WebSocket #}
        proxy_set_header Upgrade $http_upgrade;  {# Передаем заголовок Upgrade #}
        proxy_set_header Connection "upgrade";  {# Обновляем заголовок Connection #}
        
        # Таймауты (Время ожидания для различных операций)
        proxy_connect_timeout 60s;  {# Тайм-аут установления соединения #}
        proxy_send_timeout 60s;  {# Тайм-аут отправки запроса #}
        proxy_read_timeout 60s;  {# Тайм-аут чтения ответа #}
        
        # Buffer настройки (Настройки буферизации ответов)
        proxy_buffering on;  {# Включаем буферизацию ответов #}
        proxy_buffer_size 128k;  {# Размер начального буфера #}
        proxy_buffers 4 256k;  {# Количество и размер буферов #}
        proxy_busy_buffers_size 256k;  {# Размер буферов для занятых соединений #}
    }

    # API rate limiting для логина (Ограничение частоты запросов для аутентификации)
    location /api/auth/ {  {# Блок для API аутентификации #}
        limit_req zone=login burst=3 nodelay;  {# Применяем rate limiting (зона login, 3 запроса в буфер) #}
        proxy_pass http://django;  {# Проксируем на Django сервер #}
        proxy_set_header Host $host;  {# Передаем заголовки как в основном блоке #}
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check (Проверка работоспособности)
    location /health/ {  {# Блок для проверки состояния сервера #}
        proxy_pass http://django;  {# Проксируем запросы проверки #}
        access_log off;  {# Отключаем логирование для экономии места #}
        proxy_cache off;  {# Отключаем кэширование #}
    }

    # Security - запрещаем доступ к служебным файлам (Защита от утечек информации)
    location ~ /\. {  {# Все файлы начинающиеся с точки (скрытые файлы) #}
        deny all;  {# Полный запрет доступа #}
        access_log off;  {# Отключаем логирование #}
        log_not_found off;  {# Не логируем отсутствие файла #}
    }

    location ~ ^/(README|CHANGELOG|LICENSE|INSTALL|\.env) {  {# Запрещаем доступ к служебным файлам проекта #}
        deny all;  {# Полный запрет доступа #}
        access_log off;  {# Отключаем логирование #}
        log_not_found off;  {# Не логируем отсутствие файла #}
    }

    # Error pages (Страницы ошибок)
    error_page 404 /404.html;  {# Страница для ошибки 404 (Not Found) #}
    error_page 500 502 503 504 /50x.html;  {# Страницы для ошибок сервера #}
    
    location = /50x.html {  {# Блок для обработки страницы 50x ошибок #}
        root /usr/share/nginx/html;  {# Корневая директория для страницы ошибки #}
    }
}